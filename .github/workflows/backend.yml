name: Backend CI

on:
  push:
    branches: ["main"]
    paths:
      - 'almizan-core/**'
  pull_request:
    branches: ["main"]
    paths:
      - 'almizan-core/**'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-C debuginfo=0"

jobs:
  # =============================================================================
  # Fast Checks - Runs in parallel for quick feedback (<30s)
  # =============================================================================
  formatting:
    name: ðŸ“ Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check Formatting
        run: cargo fmt --manifest-path almizan-core/Cargo.toml -- --check

  # =============================================================================
  # Main Build & Test - Cached for speed
  # =============================================================================
  build-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./almizan-core

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "almizan-core -> target"
          cache-on-failure: true

      - name: Build
        run: cargo build --release

      - name: Run Tests
        run: cargo test --release

  # =============================================================================
  # Lint & Security - Parallel with build
  # =============================================================================
  clippy:
    name: ðŸ” Clippy Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./almizan-core

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "almizan-core -> target"

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  security:
    name: ðŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./almizan-core

    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit

      - name: Run Security Audit
        run: cargo audit

  # =============================================================================
  # Status Gate - Ensures all checks pass
  # =============================================================================
  ci-status:
    name: âœ… CI Status
    runs-on: ubuntu-latest
    needs: [formatting, build-test, clippy, security]
    if: always()

    steps:
      - name: Check All Jobs
        run: |
          if [ "${{ needs.formatting.result }}" != "success" ] || \
             [ "${{ needs.build-test.result }}" != "success" ] || \
             [ "${{ needs.clippy.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ]; then
            echo "âŒ One or more CI checks failed"
            exit 1
          fi
          echo "âœ… All CI checks passed"

      - name: CI Summary
        run: |
          echo "## ðŸ”¨ CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.formatting.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy | ${{ needs.clippy.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
