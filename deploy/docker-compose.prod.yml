version: '3.8'

services:
  # The Gateway
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/active_upstream.conf:/etc/nginx/conf.d/active_upstream.conf:ro
    depends_on:
      - almizan-core-blue
      - almizan-core-green
    networks:
      - app_network

  # Blue Slot
  almizan-core-blue:
    image: ghcr.io/${repo_owner_lower}/almizan-core:latest
    container_name: almizan-core-blue
    restart: always
    environment:
      - DB_URL=${DB_URL}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NS=${DB_NS}
      - DB_DB=${DB_DB}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - app_network

  # Green Slot
  almizan-core-green:
    image: ghcr.io/${repo_owner_lower}/almizan-core:latest
    container_name: almizan-core-green
    restart: always
    environment:
      - DB_URL=${DB_URL}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NS=${DB_NS}
      - DB_DB=${DB_DB}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - app_network

  # Watchtower for auto-updating containers (optional helper)
  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 300 almizan-core-blue almizan-core-green

networks:
  app_network:
    driver: bridge
