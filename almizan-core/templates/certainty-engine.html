{% extends "base.html" %}

{% block title %}Certainty Engine | Al-Mizan{% endblock %}

{% block content %}
<!-- Styles now in pages.css -->

<div class="landing-page noise-overlay" style="min-height: 80vh;">
    <!-- Background Effects -->
    <div class="mesh-background" style="opacity: 0.3;">
        <div class="mesh-blob mesh-blob--gold morph-blob"></div>
        <div class="mesh-blob mesh-blob--blue morph-blob" style="animation-delay: -5s;"></div>
    </div>

    <div class="ce-hero">
        <h1 class="ce-title">Certainty Engine</h1>
        <p class="ce-subtitle">
            Theologically-aligned synthesis of Islamic law and ethics.<br>
            Trace every ruling back to its primary source with <span class="text-shimmer">mathematical certainty</span>.
        </p>
    </div>

    <div class="mufti-box hover-lift">
        <form id="muftiForm" class="mufti-input-group" aria-controls="result">
            <input type="text" id="topicInput" class="mufti-input"
                placeholder="Search topic (e.g., Bitcoin, Inheritance, Zakat)..." required autocomplete="off" aria-label="Search topic for synthesis">
            <button type="submit" class="mufti-btn glow-pulse" id="synthesizeBtn" aria-label="Synthesize Islamic ruling">
                <span>Synthesize</span>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
        </form>

        <!-- Sample Queries -->
        <div style="margin-top: 1.5rem; text-align: center;">
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">Try these sample queries:</p>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                <button class="sample-query" onclick="fillQuery('Bitcoin')">Bitcoin</button>
                <button class="sample-query" onclick="fillQuery('Zakat')">Zakat</button>
                <button class="sample-query" onclick="fillQuery('Inheritance')">Inheritance</button>
                <button class="sample-query" onclick="fillQuery('Riba')">Riba</button>
                <button class="sample-query" onclick="fillQuery('Cryptocurrency')">Cryptocurrency</button>
                <button class="sample-query" onclick="fillQuery('Music')">Music</button>
                <button class="sample-query" onclick="fillQuery('Insurance')">Insurance</button>
                <button class="sample-query" onclick="fillQuery('Stock Trading')">Stock Trading</button>
                <button class="sample-query" onclick="fillQuery('Mortgage')">Mortgage</button>
                <button class="sample-query" onclick="fillQuery('Islamic Finance')">Islamic Finance</button>
            </div>
        </div>
    </div>

    <style>
        .sample-query {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--color-gold);
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .sample-query:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--color-gold);
            transform: translateY(-2px);
        }

        [data-theme="light"] .sample-query {
            background: #ffffff;
            border: 2px solid #1f2937;
            color: #1f2937;
            font-weight: 600;
        }

        [data-theme="light"] .sample-query:hover {
            background: #1f2937;
            color: #ffffff;
        }
    </style>

    <div id="traceAnimation" class="trace-container">
        <div class="trace-node" style="animation-delay: 0s"></div>
        <div class="trace-node" style="animation-delay: 0.2s"></div>
        <div class="trace-node" style="animation-delay: 0.4s"></div>
        <div class="trace-node" style="animation-delay: 0.6s"></div>
        <p
            style="margin-top: 1rem; font-size: 0.8rem; color: var(--color-gold); text-transform: uppercase; letter-spacing: 3px;">
            Consulting Al-Mizan Graph...</p>
    </div>

    <div id="result" style="max-width: 800px; margin: 0 auto; padding-bottom: 4rem;" aria-live="polite" aria-atomic="true"></div>
</div>

<script>
    // Fill input with sample query and submit
    function fillQuery(query) {
        const input = document.getElementById('topicInput');
        input.value = query;
        document.getElementById('muftiForm').dispatchEvent(new Event('submit'));
    }

    document.getElementById('muftiForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const topic = document.getElementById('topicInput').value;
        const trace = document.getElementById('traceAnimation');
        const result = document.getElementById('result');
        const btn = document.getElementById('synthesizeBtn');

        // UI Reset
        trace.style.display = 'block';
        btn.disabled = true;
        btn.style.opacity = '0.5';
        result.innerHTML = '';

        try {
            const response = await fetch('/api/v1/synthesis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic: topic })
            });

            const data = await response.json();
            const disclaimer = response.headers.get('X-Disclaimer') || 'Advisory only. Consult a local Mufti for binding fatwas.';

            const colorMap = {
                "Red": "#EF4444",
                "Yellow": "#EAB308",
                "Green": "#10B981"
            };
            const themeColor = colorMap[data.status] || "#D4AF37";

            // Artificial delay for animation feel
            await new Promise(r => setTimeout(r, 1200));

            trace.style.display = 'none';

            result.innerHTML = `
                <div class="verdict-card glass-ultra">
                    <div class="gauge-wrapper">
                        <svg class="gauge-svg" width="140" height="140">
                            <circle class="gauge-bg" cx="70" cy="70" r="65"></circle>
                            <circle class="gauge-progress" id="gaugeCircle" cx="70" cy="70" r="65" style="stroke: ${themeColor}"></circle>
                        </svg>
                        <div class="gauge-text">${(data.consensus_score * 100).toFixed(0)}%</div>
                    </div>

                    <div class="scholar-header">
                        <img src="${data.scholar_avatar}" class="scholar-img" style="border-color: ${themeColor}">
                        <div class="scholar-info">
                            <h4>Synthesis Authority</h4>
                            <div class="name">${data.primary_scholar}</div>
                        </div>
                    </div>

                    <h2 style="text-align: center; color: ${themeColor}; font-size: 2.5rem; font-weight: 800; margin-bottom: 2rem; text-shadow: 0 0 20px ${themeColor}40;">
                        ${data.status.toUpperCase()}
                    </h2>

                    <div class="verdict-summary">
                        ${data.summary}
                    </div>

                    <div class="verdict-disclaimer">
                        <strong>Protocol Notice:</strong> ${disclaimer}
                    </div>
                </div>
            `;

            // Trigger Gauge Animation
            setTimeout(() => {
                const circle = document.getElementById('gaugeCircle');
                if (circle) {
                    // circumference 2 * PI * 65 â‰ˆ 408
                    const offset = 408 - (data.consensus_score * 408);
                    circle.style.strokeDashoffset = offset;
                }
            }, 100);

        } catch (error) {
            trace.style.display = 'none';
            result.innerHTML = `
                <div class="verdict-card" style="border-color: #EF4444; border-top-width: 4px;">
                    <p style="color: #EF4444; font-weight: 700; text-align: center;">Synthesis Engine Fault: ${error.message}</p>
                </div>
            `;
        } finally {
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    });
</script>
{% endblock %}